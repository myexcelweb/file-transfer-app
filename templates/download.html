<!DOCTYPE html>
<html>

<head>
    <title>Download Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static_files', filename='style.css') }}">
</head>

<body>

    <div class="container">
        {% if error %}
        <div class="card error-page">
            <h2>‚ùå Error</h2>
            <p>{{ error }}</p>
            <a href="/" class="link-back">‚Üê Back to Home</a>
        </div>
        {% else %}
        <div class="card success-page">
            <h2>‚úÖ Files Ready</h2>

            <div class="code-display-small">Code: {{ code }}</div>

            <button class="btn-copy" onclick="copyCode('{{ code }}')">
                üìã Copy Code
            </button>

            <div class="timer-container">
                <p class="timer-label">‚è±Ô∏è Time Remaining:</p>
                <div class="countdown-timer" id="countdown-timer">
                    <span id="timer-display">Loading...</span>
                </div>
                <p class="timer-warning" id="timer-warning" style="display: none;">
                    ‚ö†Ô∏è Files will be deleted automatically when timer expires
                </p>
            </div>

            {% if share_url %}
            <div class="share-section">
                <h4>Share this link:</h4>
                <div class="share-url-container">
                    <input type="text" id="shareUrl" value="{{ share_url }}" readonly class="share-url-input">
                    <button class="btn-copy-small" onclick="copyUrl()">
                        üìã Copy Link
                    </button>
                </div>

                <!-- URL QR Code for this specific download link -->
                <div class="url-qr-container">
                    <div class="url-qr-header">
                        <span class="url-qr-title">üì± Scan QR Code</span>
                        <span class="url-qr-subtitle">Share this link via QR code</span>
                    </div>
                    <div class="url-qr-wrapper">
                        <div id="url-qr-code" class="url-qr-code"></div>
                    </div>
                    <p class="url-qr-instruction">Scan with mobile camera to open this download page</p>
                    <button class="btn-copy-small btn-download-qr" onclick="downloadQRCode()">
                        ‚¨áÔ∏è Download QR Code
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="files-container">
                <h3>Available Files:</h3>

                {% for file in files %}
                <div class="download-file-item">
                    <div class="file-info">
                        <span class="file-type-badge">{{ file.type }}</span>
                        <div class="file-details">
                            <span class="file-name">{{ file.original_name }}</span>
                            <span class="file-size-small">{{ file.size }}</span>
                        </div>
                    </div>

                    <a href="{{ url_for('get_file', code=code, index=loop.index0) }}" class="btn-icon"
                        title="Download {{ file.original_name }}">
                        üì•
                    </a>
                </div>
                {% endfor %}
            </div>

            {% if files|length > 1 %}
            <a href="{{ url_for('get_all_files', code=code) }}" class="btn btn-download">
                üì¶ Download All Files (ZIP)
            </a>
            {% else %}
            <a href="{{ url_for('get_file', code=code, index=0) }}" class="btn btn-download">
                üì• Download File
            </a>
            {% endif %}

            <a href="/" class="link-back">‚Üê Back to Home</a>
        </div>
        {% endif %}
    </div>

    <!-- Website QR Code Section - Above Footer -->
    <div class="qr-bottom-section">
        <div class="qr-bottom-container">
            <img src="{{ url_for('static_files', filename='URL_QR_Code.png') }}" alt="QR Code" class="qr-bottom-image"
                title="Scan to open this website on your mobile device">
            <div class="qr-bottom-text">
                <span class="qr-bottom-title">üì± Mobile Access</span>
                <span class="qr-bottom-subtitle">Scan to open this website on your phone</span>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>
            Designed & Developed by Parimal Hodar |
            <a href="mailto:parimalhodar.dev@gmail.com">
                parimalhodar.dev@gmail.com
            </a>
        </p>
    </footer>

    <script>
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(() => {
                alert('Failed to copy code');
            });
        }

        function copyUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(urlInput.value).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(() => {
                document.execCommand('copy');
            });
        }

        // QR Code Functions
        function generateUrlQRCode() {
            const shareUrl = document.getElementById('shareUrl')?.value;
            if (shareUrl) {
                // Load QR code library dynamically
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js';
                script.onload = function () {
                    const qrContainer = document.getElementById('url-qr-code');
                    if (qrContainer) {
                        qrContainer.innerHTML = ''; // Clear previous QR
                        QRCode.toCanvas(shareUrl, {
                            width: 180,
                            margin: 2,
                            color: {
                                dark: '#667eea',
                                light: '#ffffff'
                            }
                        }, function (error, canvas) {
                            if (error) {
                                console.error(error);
                                qrContainer.innerHTML = '<p class="error-text">Failed to generate QR</p>';
                            } else {
                                qrContainer.appendChild(canvas);
                                canvas.style.cursor = 'pointer';
                                canvas.title = 'Click to download QR Code';
                                canvas.onclick = function () {
                                    downloadQRCodeFromCanvas(canvas);
                                };
                            }
                        });
                    }
                };
                document.head.appendChild(script);
            }
        }

        function downloadQRCode() {
            const canvas = document.querySelector('#url-qr-code canvas');
            if (canvas) {
                downloadQRCodeFromCanvas(canvas);
            }
        }

        function downloadQRCodeFromCanvas(canvas) {
            const link = document.createElement('a');
            link.download = `file-transfer-${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function startCountdown(code) {
            const timerDisplay = document.getElementById('timer-display');
            const timerWarning = document.getElementById('timer-warning');
            const countdownTimer = document.getElementById('countdown-timer');

            function updateTimer() {
                fetch(`/api/check/${code}`)
                    .then(response => response.json())
                    .then(data => {

                        if (!data.valid || data.expired) {
                            timerDisplay.textContent = 'EXPIRED';
                            timerDisplay.style.color = '#c62828';
                            countdownTimer.style.background = '#ffebee';
                            timerWarning.style.display = 'block';
                            timerWarning.textContent =
                                '‚ùå Files have been deleted. Redirecting to home...';
                            timerWarning.style.color = '#c62828';

                            setTimeout(() => {
                                window.location.href = '/';
                            }, 3000);

                            return;
                        }

                        const minutes = Math.floor(data.remaining_seconds / 60);
                        const seconds = data.remaining_seconds % 60;

                        timerDisplay.textContent =
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        if (data.remaining_seconds <= 60) {
                            timerDisplay.style.color = '#c62828';
                            countdownTimer.style.background = '#ffebee';
                            timerWarning.style.display = 'block';
                        } else if (data.remaining_seconds <= 300) {
                            timerDisplay.style.color = '#f57c00';
                            countdownTimer.style.background = '#fff3e0';
                        } else {
                            timerDisplay.style.color = '#2e7d32';
                            countdownTimer.style.background = '#e8f5e9';
                        }

                        setTimeout(updateTimer, 1000);
                    })
                    .catch(() => {
                        timerDisplay.textContent = 'ERROR';
                    });
            }

            updateTimer();
        }

        // Get values from Flask
        const downloadCode = "{{ code | default('') }}";

        // Start countdown if code exists
        if (downloadCode) {
            startCountdown(downloadCode);
        }

        // Generate QR code if share_url exists (checked by checking if element exists)
        setTimeout(function () {
            if (document.getElementById('shareUrl')) {
                generateUrlQRCode();
            }
        }, 500);

    </script>

</body>

</html>