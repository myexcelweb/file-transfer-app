<!DOCTYPE html>
<html>

<head>
    <title>Download Files</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static_files', filename='style.css') }}">
</head>

<body>

    <div class="container">
        {% if error %}
        <div class="card error-page">
            <h2>‚ùå Error</h2>
            <p>{{ error }}</p>
            <a href="/" class="link-back">‚Üê Back to Home</a>
        </div>
        {% else %}
        <div class="card success-page">
            <h2>‚úÖ Files Ready</h2>

            <div class="code-display-small">Code: {{ code }}</div>

            <button class="btn-copy" onclick="copyCode('{{ code }}')">
                üìã Copy Code
            </button>

            <div class="timer-container">
                <p class="timer-label">‚è±Ô∏è Time Remaining:</p>
                <div class="countdown-timer" id="countdown-timer">
                    <span id="timer-display">Loading...</span>
                </div>
                <p class="timer-warning" id="timer-warning" style="display: none;">
                    ‚ö†Ô∏è Files will be deleted automatically when timer expires
                </p>
            </div>

            {% if share_url %}
            <div class="share-section">
                <h4>Share this link:</h4>
                <div class="share-url-container">
                    <input type="text" id="shareUrl" value="{{ share_url }}" readonly class="share-url-input">
                    <button class="btn-copy-small" onclick="copyUrl()">
                        üìã Copy Link
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="files-container">
                <h3>Available Files:</h3>

                {% for file in files %}
                <div class="download-file-item">
                    <div class="file-info">
                        <span class="file-type-badge">{{ file.type }}</span>
                        <div class="file-details">
                            <span class="file-name">{{ file.original_name }}</span>
                            <span class="file-size-small">{{ file.size }}</span>
                        </div>
                    </div>

                    <a href="{{ url_for('get_file', code=code, index=loop.index0) }}" class="btn-icon"
                        title="Download {{ file.original_name }}">
                        üì•
                    </a>
                </div>
                {% endfor %}
            </div>

            {% if files|length > 1 %}
            <a href="{{ url_for('get_all_files', code=code) }}" class="btn btn-download">
                üì¶ Download All Files (ZIP)
            </a>
            {% else %}
            <a href="{{ url_for('get_file', code=code, index=0) }}" class="btn btn-download">
                üì• Download File
            </a>
            {% endif %}

            <a href="/" class="link-back">‚Üê Back to Home</a>
        </div>
        {% endif %}
    </div>

    <footer class="footer">
        <p>
            Designed & Developed by Parimal Hodar |
            <a href="mailto:parimalhodar.dev@gmail.com">
                parimalhodar.dev@gmail.com
            </a>
        </p>
    </footer>

    <script>
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(() => {
                alert('Failed to copy code');
            });
        }

        function copyUrl() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(urlInput.value).then(() => {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                btn.style.background = '#4CAF50';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(() => {
                document.execCommand('copy');
            });
        }

        function startCountdown(code) {
            const timerDisplay = document.getElementById('timer-display');
            const timerWarning = document.getElementById('timer-warning');
            const countdownTimer = document.getElementById('countdown-timer');

            function updateTimer() {
                fetch(`/api/check/${code}`)
                    .then(response => response.json())
                    .then(data => {

                        if (!data.valid || data.expired) {
                            timerDisplay.textContent = 'EXPIRED';
                            timerDisplay.style.color = '#c62828';
                            countdownTimer.style.background = '#ffebee';
                            timerWarning.style.display = 'block';
                            timerWarning.textContent =
                                '‚ùå Files have been deleted. Redirecting to home...';
                            timerWarning.style.color = '#c62828';

                            setTimeout(() => {
                                window.location.href = '/';
                            }, 3000);

                            return;
                        }

                        const minutes = Math.floor(data.remaining_seconds / 60);
                        const seconds = data.remaining_seconds % 60;

                        timerDisplay.textContent =
                            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        if (data.remaining_seconds <= 60) {
                            timerDisplay.style.color = '#c62828';
                            countdownTimer.style.background = '#ffebee';
                            timerWarning.style.display = 'block';
                        } else if (data.remaining_seconds <= 300) {
                            timerDisplay.style.color = '#f57c00';
                            countdownTimer.style.background = '#fff3e0';
                        } else {
                            timerDisplay.style.color = '#2e7d32';
                            countdownTimer.style.background = '#e8f5e9';
                        }

                        setTimeout(updateTimer, 1000);
                    })
                    .catch(() => {
                        timerDisplay.textContent = 'ERROR';
                    });
            }

            updateTimer();
        }

        // ‚úÖ SAFE JINJA ‚Üí JS (NO VS CODE ERRORS)
        const downloadCode = "{{ code | default('') }}";

        if (downloadCode) {
            startCountdown(downloadCode);
        }

    </script>

</body>

</html>